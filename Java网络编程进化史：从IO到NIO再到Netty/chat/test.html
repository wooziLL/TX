<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>ç¾¤èŠå¤©å®¤</title>
    <style type="text/css">
        body {
            margin-right:50px;
            margin-left:50px;
        }
        .ddois {
            position: fixed;
            left: 120px;
            bottom: 30px;
        }
    </style>
</head>
<body>
ç¾¤åï¼š<input type="text" id="room" name="group" placeholder="è¯·è¾“å…¥ç¾¤">
<br /><br />
æ˜µç§°ï¼š<input type="text" id="nick" name="name" placeholder="è¯·è¾“å…¥æ˜µç§°">
<br /><br />
<button type="button" onclick="enter()">è¿›å…¥èŠå¤©ç¾¤</button>
<br /><br />
<div id="message"></div>
<br /><br />
<div class="ddois">
    <textarea name="send" id="text" rows="10" cols="30" placeholder="è¾“å…¥å‘é€æ¶ˆæ¯"></textarea>
    <br /><br />
    <button type="button" onclick="send()">å‘é€</button>
</div>
<script type="text/javascript">
    var webSocket;

    if (window.WebSocket) {
        webSocket = new WebSocket("ws://localhost:53134/ws");
    } else {
        alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketåè®®!");
    }

    //è¿é€šä¹‹åçš„å›è°ƒäº‹ä»¶
    webSocket.onopen = function() {
        console.log("å·²ç»è¿é€šäº†websocket");
//                setMessageInnerHTML("å·²ç»è¿é€šäº†websocket");
    };
    //è¿æ¥å‘ç”Ÿé”™è¯¯çš„å›è°ƒæ–¹æ³•
    webSocket.onerror = function(event){
        console.log("å‡ºé”™äº†");
//              setMessageInnerHTML("è¿æ¥å¤±è´¥");
    };

    //è¿æ¥å…³é—­çš„å›è°ƒæ–¹æ³•
    webSocket.onclose = function(){
        console.log("è¿æ¥å·²å…³é—­...");

    }

    //æ¥æ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒæ–¹æ³•
    webSocket.onmessage = function(event){
        console.log("bbdds");
        var data = JSON.parse(event.data)
        var msg = data.msg;
        var nick = data.sendUser;
        switch(data.type){
            case 'init':
                console.log("mmll");
                break;
            case 'msg':
                console.log("bblld");
                setMessageInnerHTML(nick+":  "+msg);
                break;
            default:
                break;
        }
    }
    function enter(){
        var map = new Map();
        var nick=document.getElementById('nick').value;
        var room=document.getElementById('room').value;
        map.set("type","init");
        map.set("nick",nick);
        console.log(room);
        map.set("room",room);
        var message = Map2Json(map);
        webSocket.send(message);
    }

    function send() {
        var msg = document.getElementById('text').value;
        var nick = document.getElementById('nick').value;
        console.log("1:"+msg);
        if (msg != null && msg != ""){
            var map = new Map();
            map.set("type","msg");
            map.set("msg",msg);
            var map2json=Map2Json(map);
            if (map2json.length < 8000){
                console.log("4:"+map2json);
                webSocket.send(map2json);
            }else {
                console.log("æ–‡æœ¬å¤ªé•¿äº†ï¼Œå°‘å†™ä¸€ç‚¹å§ğŸ˜­");
            }
        }
    }

    //å°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Š
    function setMessageInnerHTML(innerHTML) {
        document.getElementById("message").innerHTML += innerHTML + "<br/>";
    }

    function Map2Json(map) {
        var str = "{";
        map.forEach(function (value, key) {
            str += '"'+key+'"'+':'+ '"'+value+'",';
        })
        str = str.substring(0,str.length-1)
        str +="}";
        return str;
    }

</script>

</body>
</html>
